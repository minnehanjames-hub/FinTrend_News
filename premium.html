<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FinTrend Premium</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Supabase -->
<link rel="icon" type="image/png" href="assets/img/favicon.png" />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KSK5YVPJBR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KSK5YVPJBR');
  </script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --bg:#050816;
      --panel: rgba(15,23,42,0.72);
      --border: rgba(148,163,184,0.28);
      --border2: rgba(148,163,184,0.45);
      --text:#f9fafb;
      --muted:#9ca3af;
      --brand:#f4c15d;
      --brand2: rgba(244,193,93,0.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }
    a:hover { color: var(--brand); }

    .wrap { max-width: 1400px; margin: 28px auto; padding: 0 16px; }

    .topbar{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brandTitle{
      font-family: "Playfair Display", serif;
      letter-spacing:.12em;
      text-transform:uppercase;
      margin:0;
      font-size: 26px;
      color: var(--brand);
    }
    .subhead{ margin:6px 0 0; color:var(--muted); font-size: 13px; }

    .card {
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .muted { color:var(--muted); }

    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--border2);
      background:rgba(2,6,23,0.40);
      color:var(--text);
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:11px;
      font-weight: 700;
      text-decoration:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      white-space:nowrap;
      font-family: inherit;
    }
    .btn.primary { background:var(--brand); color:#000; border-color:var(--brand); font-weight:900; }
    .btn.primary:hover { background:#f7d680; transform: translateY(-1px); }
    .btn:hover { transform: translateY(-1px); border-color: rgba(244,193,93,0.45); }
    .btn:active { transform: translateY(0px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: rgba(2,6,23,0.35);
      font-size:12px;
      color: var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .pill.active { border-color: rgba(244,193,93,0.55); color: var(--brand); background: rgba(244,193,93,0.08); }

    .layout {
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

    .sectionTitle{
      margin:0;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size:11px;
      color: var(--muted);
    }
    .h2{
      margin:8px 0 0;
      font-family: "Playfair Display", serif;
      font-size:22px;
      line-height:1.2;
    }

    .divider{
      height:1px;
      background: rgba(148,163,184,0.18);
      margin: 14px 0;
    }

    .checkgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .check{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.22);
      cursor: pointer;
      transition: border-color .15s;
    }
    .check:hover { border-color: rgba(244,193,93,0.35); }
    .check input{
      margin-top:3px;
      width:18px; height:18px;
      accent-color: var(--brand);
      cursor:pointer;
      flex-shrink: 0;
    }
    .check strong{ display:block; font-size: 13px; }
    .check small{ display:block; margin-top:3px; color: var(--muted); line-height:1.35; font-size: 12px; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.25);
      color: var(--text);
      font-size:12px;
    }
    .chip span{ color: var(--muted); letter-spacing:.10em; text-transform:uppercase; font-size:11px; }

    .modules {
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .moduleHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .moduleMeta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.25);
      color: var(--muted);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      background: rgba(2,6,23,0.25);
    }
    .moduleTitle{ margin:6px 0 0; font-size:18px; font-family: "Playfair Display", serif; }
    .moduleDesc{ margin:8px 0 0; color: var(--muted); line-height:1.6; font-size: 13px; }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){ .twoCols{ grid-template-columns: 1fr; } }

    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{
      font-size:11px; color: var(--muted);
      letter-spacing:.12em; text-transform:uppercase;
    }
    textarea, input[type="text"], input[type="number"], select{
      background: rgba(2,6,23,0.50);
      border:1px solid rgba(148,163,184,0.22);
      color: var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      width:100%;
      box-sizing:border-box;
      font-family: inherit;
      font-size: 13px;
      transition: border-color .15s;
    }
    textarea:focus, input:focus, select:focus {
      border-color: rgba(244,193,93,0.45);
    }
    textarea{ min-height: 120px; resize: vertical; }

    pre{
      background: rgba(2,6,23,0.50);
      border:1px solid rgba(148,163,184,0.18);
      padding:14px;
      border-radius:14px;
      overflow:auto;
      color: #e5e7eb;
      line-height:1.6;
      margin: 10px 0 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 13px;
    }
    .note{
      font-size:12px;
      color: var(--muted);
      margin-top: 10px;
      line-height:1.5;
    }

    /* Archive / deep dive */
    .archiveRow{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
      padding:12px; border-radius:14px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.22);
      cursor:pointer;
      transition: border-color .15s;
    }
    .archiveRow:hover{ border-color: rgba(244,193,93,.45); }
    .archiveMeta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .miniChip{
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.25);
      color: var(--muted);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .searchRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }

    .dd-shell{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:10px;
      margin-top: 12px;
      align-items:start;
    }
    @media (max-width: 980px){ .dd-shell{ grid-template-columns: 1fr; } }
    .dd-shell.reading{ grid-template-columns: 1fr; }
    .dd-shell.reading #ddArchiveCard{ display:none; }
    #ddViewerCard{ min-width:0; }
    .ddViewerTop{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;
      margin-bottom: 10px;
    }

    .article-body{
      max-width: 92ch;
      margin: 0 auto;
      font-size: 15px;
      line-height: 1.85;
      color: #e5e7eb;
    }
    .dd-shell.reading .article-body{ max-width: 105ch; }
    .article-body p{ margin: 0 0 14px; }
    .article-body h2{ font-size: 22px; margin: 22px 0 10px; line-height: 1.25; font-family: "Playfair Display", serif; }
    .article-body h3{ font-size: 18px; margin: 16px 0 8px; line-height: 1.25; color: #f9fafb; }
    .article-body ul, .article-body ol{ margin: 8px 0 14px; padding-left: 18px; }
    .article-body li{ margin: 8px 0; }
    .article-body blockquote{
      margin: 16px 0; padding: 12px 14px;
      border-left: 3px solid rgba(244,193,93,.7);
      background: rgba(2,6,23,0.35);
      border-radius: 12px;
    }
    .article-body hr{ border: none; height: 1px; background: rgba(148,163,184,0.18); margin: 18px 0; }
    .article-body a{ color: var(--brand); }
    .article-body a:hover{ text-decoration: underline; }

    /* Ideas cards */
    .ideaCard{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.35);
      border-radius:16px;
      padding:16px;
      transition: border-color .15s, transform .15s;
    }
    .ideaCard:hover{ border-color: rgba(244,193,93,0.35); transform: translateY(-2px); }
    .ideaTicker{
      font-family: "Playfair Display", serif;
      font-size: 28px;
      color: var(--brand);
      line-height: 1;
      margin-bottom: 6px;
    }
    .ideaSector{
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .ideaRow{
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .ideaLabel{
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
      min-width: 72px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(2,6,23,0.25);
      line-height: 1.4;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .ideaText{
      font-size: 13px;
      color: #e5e7eb;
      line-height: 1.5;
    }
    .ideaGrid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    /* Roundup cards */
    .roundupCard{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.35);
      border-radius:16px;
      padding:16px;
      margin-bottom: 10px;
      transition: border-color .15s;
    }
    .roundupCard:hover{ border-color: rgba(244,193,93,0.35); }
    .roundupTitle{
      font-family: "Playfair Display", serif;
      font-size: 17px;
      color: var(--text);
      margin-bottom: 6px;
    }
    .roundupMeta{
      display: flex; gap: 8px; flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .roundupContent{
      font-size: 13px;
      color: #d1d5db;
      line-height: 1.65;
      white-space: pre-wrap;
    }

    /* ===== QUANT LAB MODALS ===== */
    .qlBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.72);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      backdrop-filter: blur(4px);
    }
    .qlBackdrop.active{ display: flex; }

    .qlModal{
      width: 100%;
      max-width: 680px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 32px 80px rgba(0,0,0,0.6);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn .22s ease;
    }
    @keyframes modalIn{
      from{ transform: translateY(16px) scale(0.97); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .qlModal.wide{ max-width: 900px; }

    .qlClose{
      position: absolute; top: 14px; right: 16px;
      background: transparent; border: none;
      color: var(--muted); font-size: 22px;
      cursor: pointer; line-height: 1;
      transition: color .15s;
    }
    .qlClose:hover{ color: var(--text); }

    .qlKicker{
      font-size: 11px; letter-spacing: .18em; text-transform: uppercase;
      color: var(--brand); margin-bottom: 8px;
    }
    .qlTitle{
      font-family: "Playfair Display", serif;
      font-size: 28px; line-height: 1.15;
      margin-bottom: 10px;
    }
    .qlSubtitle{
      font-size: 14px; color: #d1d5db;
      line-height: 1.65; margin-bottom: 18px;
      max-width: 58ch;
    }

    .qlInfoGrid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 18px 0;
    }
    @media (max-width: 600px){ .qlInfoGrid{ grid-template-columns: 1fr; } }

    .qlInfoCard{
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(2,6,23,0.45);
      border-radius: 14px;
      padding: 14px;
    }
    .qlInfoCard .qlInfoIcon{
      font-size: 22px; margin-bottom: 8px;
    }
    .qlInfoCard .qlInfoLabel{
      font-size: 10px; letter-spacing: .14em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 4px;
    }
    .qlInfoCard .qlInfoText{
      font-size: 12px; color: #e5e7eb; line-height: 1.5;
    }

    .qlWarning{
      display: flex; gap: 10px; align-items: flex-start;
      padding: 12px 14px;
      border: 1px solid rgba(244,193,93,0.3);
      background: rgba(244,193,93,0.06);
      border-radius: 12px;
      margin: 14px 0;
      font-size: 12px;
      color: #e5e7eb;
      line-height: 1.5;
    }
    .qlWarning::before{ content: "‚ö†Ô∏è"; flex-shrink: 0; }

    .qlBtnRow{
      display: flex; gap: 10px; flex-wrap: wrap;
      margin-top: 18px;
    }

    /* Calc modal */
    .qlSection{
      margin-bottom: 18px;
    }
    .qlSectionTitle{
      font-size: 11px; letter-spacing: .16em; text-transform: uppercase;
      color: var(--brand); margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(244,193,93,0.2);
    }

    .qlInputGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 600px){ .qlInputGrid{ grid-template-columns: 1fr; } }

    .qlAssetRow{
      display: grid;
      grid-template-columns: 100px 1fr 1fr 1fr;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    @media (max-width: 600px){ .qlAssetRow{ grid-template-columns: 1fr 1fr; } }

    .qlAssetLabel{
      font-size: 12px; color: var(--brand); font-weight: 700;
      letter-spacing: .08em;
    }

    .qlColHeader{
      display: grid;
      grid-template-columns: 100px 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 4px;
    }
    @media (max-width: 600px){ .qlColHeader{ display:none; } }

    .qlColHeaderLabel{
      font-size: 10px; letter-spacing: .12em; text-transform: uppercase;
      color: var(--muted);
    }

    .qlResults{
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 14px;
      padding: 16px;
      margin-top: 14px;
    }
    .qlResultsTitle{
      font-size: 11px; letter-spacing: .16em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 12px;
    }
    .qlResultGrid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .qlResultCell{
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(15,23,42,0.5);
      border-radius: 10px;
      padding: 10px;
    }
    .qlResultCellLabel{
      font-size: 10px; letter-spacing: .12em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 4px;
    }
    .qlResultCellValue{
      font-size: 18px; font-weight: 700; color: var(--brand);
      font-family: "Playfair Display", serif;
    }
    .qlResultCellSub{
      font-size: 11px; color: var(--muted); margin-top: 2px;
    }

    .qlWeightBar{
      display: flex;
      gap: 4px;
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      margin: 10px 0 6px;
    }
    .qlWeightBarSeg{
      height: 100%;
      transition: width .4s ease;
      border-radius: 999px;
    }

    .qlWeightLegend{
      display: flex; gap: 12px; flex-wrap: wrap;
    }
    .qlWeightLegendItem{
      display: flex; align-items: center; gap: 5px;
      font-size: 12px; color: #d1d5db;
    }
    .qlWeightLegendDot{
      width: 8px; height: 8px; border-radius: 999px;
    }

    .qlError{
      color: #f87171;
      font-size: 13px;
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(248,113,113,0.25);
      background: rgba(248,113,113,0.06);
      border-radius: 10px;
      display: none;
    }

    .qlSpinner{
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid rgba(244,193,93,0.3);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Loading states */
    .loadingPulse{
      animation: pulse 1.5s ease infinite;
    }
    @keyframes pulse{
      0%,100%{ opacity:1; }
      50%{ opacity:.4; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width:6px; height:6px; }
    ::-webkit-scrollbar-track{ background: rgba(2,6,23,0.3); }
    ::-webkit-scrollbar-thumb{ background: rgba(148,163,184,0.3); border-radius:999px; }
    ::-webkit-scrollbar-thumb:hover{ background: rgba(244,193,93,0.4); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="brandTitle">FinTrend Premium</h1>
        <p class="subhead">Members-only dashboard.</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill" id="memberPill">Checking‚Ä¶</span>
        <a class="btn" href="index.html">‚Üê Back</a>
      </div>
    </div>

    <div id="state" class="card">
      <p class="muted loadingPulse">Verifying your access‚Ä¶</p>
    </div>
    <div id="content" style="display:none;"></div>
  </div>

  <!-- ===== QUANT LAB MODAL 1: Explainer ===== -->
  <div class="qlBackdrop" id="qlExplainer">
    <div class="qlModal">
      <button class="qlClose" id="qlExplainerClose">√ó</button>
      <div class="qlKicker">Premium Tool</div>
      <h2 class="qlTitle">Quant Lab</h2>
      <p class="qlSubtitle">
        A professional-grade portfolio optimization engine built directly into your dashboard.
        It combines two of the most widely used frameworks in quantitative finance.
      </p>

      <div class="qlInfoGrid">
        <div class="qlInfoCard">
          <div class="qlInfoIcon">‚öñÔ∏è</div>
          <div class="qlInfoLabel">Mean-Variance Optimization</div>
          <div class="qlInfoText">
            Finds the portfolio weights that maximize expected return for a given level of risk ‚Äî
            the mathematical foundation of modern portfolio theory, developed by Harry Markowitz (Nobel Prize, 1990).
          </div>
        </div>
        <div class="qlInfoCard">
          <div class="qlInfoIcon">üé≤</div>
          <div class="qlInfoLabel">Monte Carlo Simulation</div>
          <div class="qlInfoText">
            Runs 20,000 simulated return scenarios using your inputs, then measures how bad
            things get in the worst outcomes ‚Äî giving you a realistic picture of tail risk.
          </div>
        </div>
        <div class="qlInfoCard">
          <div class="qlInfoIcon">üìâ</div>
          <div class="qlInfoLabel">CVaR (Conditional Value at Risk)</div>
          <div class="qlInfoText">
            Goes beyond VaR to ask: "When things go wrong, how bad is the average loss?"
            Used by institutional risk desks as a more conservative and complete risk measure.
          </div>
        </div>
      </div>

      <div class="qlWarning">
        This tool is for educational and analytical purposes only. It is not financial advice.
        All inputs are your own estimates ‚Äî outputs are only as good as your assumptions.
        Past covariance and return estimates do not guarantee future results.
      </div>

      <p style="font-size:13px; color:#d1d5db; line-height:1.65;">
        <strong style="color:var(--text);">What you'll input:</strong> Expected annual returns for up to 5 assets,
        their volatilities, and correlations between them. The optimizer finds the mathematically
        optimal allocation, then stress-tests it with a Monte Carlo simulation to show you
        95% VaR and CVaR ‚Äî the same metrics used by hedge funds and institutional desks.
      </p>

      <div class="qlBtnRow">
        <button class="btn primary" id="qlOpenCalc">Understood ‚Äî Open Calculator</button>
        <button class="btn" id="qlNevermind">Nevermind</button>
      </div>
    </div>
  </div>

  <!-- ===== QUANT LAB MODAL 2: Calculator ===== -->
  <div class="qlBackdrop" id="qlCalc">
    <div class="qlModal wide">
      <button class="qlClose" id="qlCalcClose">√ó</button>
      <div class="qlKicker">Quant Lab ¬∑ Calculator</div>
      <h2 class="qlTitle" style="font-size:22px; margin-bottom:16px;">Portfolio Optimizer</h2>

      <!-- Assets -->
      <div class="qlSection">
        <div class="qlSectionTitle">Assets & Expected Returns</div>
        <p style="font-size:12px; color:var(--muted); margin-bottom:12px;">
          Enter 2‚Äì5 assets. Use annualized expected returns (e.g. 0.10 = 10%). Volatility = annualized standard deviation.
        </p>

        <div class="qlColHeader">
          <div class="qlColHeaderLabel">Asset</div>
          <div class="qlColHeaderLabel">Ticker / Name</div>
          <div class="qlColHeaderLabel">Exp. Return (Œº)</div>
          <div class="qlColHeaderLabel">Volatility (œÉ)</div>
        </div>

        <div id="assetRows">
          <!-- Generated by JS -->
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="addAssetBtn">+ Add Asset</button>
          <button class="btn" id="removeAssetBtn">‚àí Remove Asset</button>
        </div>
      </div>

      <!-- Correlations -->
      <div class="qlSection">
        <div class="qlSectionTitle">Correlations Between Assets</div>
        <p style="font-size:12px; color:var(--muted); margin-bottom:12px;">
          Enter correlation coefficients between ‚àí1 and 1. (e.g. 0.3 = moderate positive correlation)
        </p>
        <div id="corrGrid" style="overflow-x:auto;"></div>
      </div>

      <!-- Settings -->
      <div class="qlSection">
        <div class="qlSectionTitle">Optimizer Settings</div>
        <div class="qlInputGrid">
          <div class="field">
            <label>Risk Aversion (Œª)</label>
            <input type="number" id="lambdaInput" value="4" min="0.5" max="20" step="0.5" />
            <div class="note">Higher = more conservative. Range: 1 (aggressive) to 10 (defensive). Typical: 3‚Äì5.</div>
          </div>
          <div class="field">
            <label>Monte Carlo Simulations</label>
            <input type="number" id="simCount" value="20000" min="1000" max="50000" step="1000" />
            <div class="note">More simulations = more accurate tail risk estimates. 20,000 is a good balance.</div>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
        <button class="btn primary" id="runOptBtn">
          Run Optimization
        </button>
        <button class="btn" id="loadExampleBtn">Load Example Portfolio</button>
        <button class="btn" id="resetCalcBtn">Reset</button>
      </div>

      <div class="qlError" id="qlError"></div>

      <!-- Results -->
      <div id="qlResults" style="display:none;">
        <div class="qlResults">
          <div class="qlResultsTitle">Optimization Results</div>

          <div style="margin-bottom:14px;">
            <div style="font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:6px;">
              Optimal Weights
            </div>
            <div class="qlWeightBar" id="weightBar"></div>
            <div class="qlWeightLegend" id="weightLegend"></div>
          </div>

          <div class="qlResultGrid" id="resultCells"></div>

          <div class="divider"></div>

          <div style="font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">
            Monte Carlo Distribution
          </div>
          <pre id="mcDetails" style="margin:0; font-size:12px;"></pre>
        </div>
      </div>

    </div>
  </div>

  <script>
  (async function(){

    const PAYMENT_LINK = "https://buy.stripe.com/aFabJ0auNdEVbnR4m2ffy00";
    const SUPABASE_URL = "https://dxmdyperxyydqdshazcp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4bWR5cGVyeHl5ZHFkc2hhemNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjMyNDQsImV4cCI6MjA4NDUzOTI0NH0.nMKF2wi8FWX0eYrDzSyJE_CPl8XgSMx27fPlcZ9gVzI";

    const stateEl = document.getElementById("state");
    const contentEl = document.getElementById("content");
    const memberPill = document.getElementById("memberPill");

    function withTimeout(promise, ms=8000){
      return Promise.race([
        promise,
        new Promise((_,reject)=>setTimeout(()=>reject(new Error("Timed out")),ms))
      ]);
    }

    const watchdog = setTimeout(()=>{
      memberPill.textContent = "Timed out";
      stateEl.innerHTML = `
        <div class="sectionTitle">Timed out</div>
        <h2 class="h2">Page didn't finish loading</h2>
        <p class="muted" style="margin-top:8px;">Try refreshing. If this keeps happening, check your connection.</p>
        <div style="display:flex;gap:10px;margin-top:12px;">
          <a class="btn primary" href="index.html">Back to Sign In</a>
        </div>`;
    }, 9000);

    function showFatal(title, msg, detail){
      clearTimeout(watchdog);
      memberPill.textContent = "Error";
      stateEl.innerHTML = `
        <div class="sectionTitle">${title}</div>
        <h2 class="h2">Something went wrong</h2>
        <p class="muted" style="margin-top:8px;">${msg}</p>
        ${detail ? `<pre style="margin-top:10px;">${detail}</pre>` : ""}
        <div style="display:flex;gap:10px;margin-top:12px;">
          <a class="btn" href="index.html">Back</a>
        </div>`;
    }

    function escHtml(s){
      return String(s??""
      ).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    function fmtDate(ts){
      try{ return new Date(ts).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}); }
      catch{ return ""; }
    }

    try{
      if(!window.supabase||!window.supabase.createClient){
        throw new Error("Supabase library not loaded.");
      }

      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storage:window.localStorage }
      });

      // Auth check
      const { data:u, error:uErr } = await withTimeout(sb.auth.getUser(), 8000);
      if(uErr) throw new Error("Auth failed: "+uErr.message);
      const user = u?.user || null;

      if(!user){
        clearTimeout(watchdog);
        memberPill.textContent = "Signed out";
        stateEl.innerHTML = `
          <div class="sectionTitle">Sign in required</div>
          <h2 class="h2">You need to be signed in</h2>
          <p class="muted" style="margin-top:8px;">Head back to sign in or create an account.</p>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <a class="btn primary" href="index.html">Sign In</a>
          </div>`;
        return;
      }

      // Profile check
      const { data:profile, error:pErr } = await withTimeout(
        sb.from("profiles").select("id,email,is_premium").eq("id",user.id).maybeSingle(), 8000
      );

      if(pErr){
        showFatal("Database error", "Could not load your profile. RLS may be blocking access.", pErr.message);
        return;
      }
      if(!profile){
        clearTimeout(watchdog);
        memberPill.textContent = "Unknown";
        stateEl.innerHTML = `
          <div class="sectionTitle">Profile missing</div>
          <h2 class="h2">Can't verify your membership</h2>
          <p class="muted" style="margin-top:8px;">Your profile row is missing. Contact support.</p>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <a class="btn" href="index.html">Home</a>
          </div>`;
        return;
      }

      if(!profile.is_premium){
        clearTimeout(watchdog);
        memberPill.textContent = "Free";
        stateEl.innerHTML = `
          <div class="sectionTitle">Premium required</div>
          <h2 class="h2">Upgrade to unlock this dashboard</h2>
          <p class="muted" style="margin-top:8px;">Signed in as <strong>${escHtml(profile.email||"")}</strong></p>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <a class="btn primary" href="${PAYMENT_LINK}" target="_blank" rel="noopener">Go Premium</a>
            <a class="btn" href="index.html">Back</a>
          </div>`;
        return;
      }

      // ‚úÖ PREMIUM UNLOCKED
      clearTimeout(watchdog);
      memberPill.textContent = "Premium ‚úì";
      memberPill.classList.add("active");
      stateEl.innerHTML = `
        <div class="sectionTitle">Access granted</div>
        <h2 class="h2">Premium active ‚úÖ</h2>
        <p class="muted" style="margin-top:6px;">Welcome back, ${escHtml(profile.email||"member")}.</p>`;

      // =============================================
      // MODULE DEFINITIONS
      // =============================================
      const STORAGE_KEY = "fintrend_premium_modules_v2";

      const MODULES = [
        {
          id:"deepdive", category:"Research", badge:"Deep Dives",
          title:"Weekly Deep Dives + Archive",
          desc:"Full-length sector reports with drivers, positioning, catalysts, and levels ‚Äî loaded live from your database.",
          render: renderDeepDives
        },
        {
          id:"ideas", category:"Ideas", badge:"On My Radar",
          title:"Curated Stock & ETF Ideas",
          desc:"Weekly watchlist with thesis, catalysts, time horizon, and risk notes for each idea.",
          render: renderIdeas
        },
        {
          id:"roundup", category:"News", badge:"Deal Tracker",
          title:"Weekly M&A ¬∑ LBO ¬∑ IPO Breakdown",
          desc:"3 deals every week ‚Äî what happened, the strategic logic, what we think happens next, and the key risk.",
          render: renderRoundups
        },
        {
          id:"templates", category:"Tools", badge:"Templates Vault",
          title:"Simple Templates (Download + Checklists)",
          desc:"Portfolio tracker, DCA planner, earnings checklist, and rebalancing checklist.",
          render: renderTemplates
        },
        {
          id:"models", category:"Portfolios", badge:"Model Portfolios",
          title:"Cautious / Balanced / Aggressive Models",
          desc:"3 model portfolio frameworks with periodic rebalance rationale and risk regime notes.",
          render: renderModels
        },
        {
          id:"quantlab", category:"Quant", badge:"Quant Lab",
          title:"Portfolio Optimizer + Monte Carlo CVaR",
          desc:"Mean-variance optimization + 20,000-scenario Monte Carlo simulation with VaR and CVaR output.",
          render: renderQuantLab
        }
      ];

      const DEFAULT = MODULES.map(m=>m.id);

      function loadSel(){
        try{
          const r=localStorage.getItem(STORAGE_KEY);
          if(!r) return DEFAULT.slice();
          const p=JSON.parse(r);
          if(!Array.isArray(p)) return DEFAULT.slice();
          return p.filter(id=>MODULES.some(m=>m.id===id));
        }catch{ return DEFAULT.slice(); }
      }
      function saveSel(s){ localStorage.setItem(STORAGE_KEY,JSON.stringify(s)); }

      let selectedIds = loadSel();

      // =============================================
      // RENDER FUNCTIONS
      // =============================================

      function renderDeepDives(){
        return `
          <div class="chips">
            <div class="chip"><span>Source</span> Supabase (RLS protected)</div>
            <div class="chip"><span>Updated</span> When you publish</div>
          </div>
          <div class="divider"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn primary" data-deepdive="latest">Open Latest Deep Dive</button>
            <button class="btn" data-deepdive="archive">Browse Archive</button>
            <button class="btn" data-deepdive="exit" style="display:none;">Exit Reader</button>
          </div>
          <div class="divider"></div>
          <div class="dd-shell" id="ddShell">
            <div class="card" id="ddArchiveCard" style="padding:14px;box-shadow:none;">
              <div class="sectionTitle">Archive</div>
              <div class="searchRow">
                <input id="ddSearch" type="text" placeholder="Search titles‚Ä¶" style="max-width:200px;" />
                <select id="ddSector"><option value="">All sectors</option></select>
                <button class="btn" data-deepdive="refresh">Refresh</button>
              </div>
              <div class="divider"></div>
              <div id="ddList" class="checkgrid" style="gap:10px;"></div>
            </div>
            <div class="card" id="ddViewerCard" style="padding:14px;box-shadow:none;">
              <div class="ddViewerTop">
                <div class="sectionTitle">Reader</div>
                <button class="btn" data-deepdive="backToArchive" style="display:none;">‚Üê Back to Archive</button>
              </div>
              <div id="ddViewer"><p class="muted">Click "Open Latest" or choose from the archive.</p></div>
            </div>
          </div>`;
      }

      function renderIdeas(){
        return `
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
            <button class="btn primary" id="loadIdeasBtn">Load Ideas</button>
            <select id="ideasSectorFilter" style="max-width:180px;">
              <option value="">All Sectors</option>
            </select>
          </div>
          <div id="ideasContainer">
            <p class="muted">Click "Load Ideas" to fetch your latest watchlist.</p>
          </div>`;
      }

      function renderRoundups(){
        return `
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
            <button class="btn primary" id="loadRoundupsBtn">Load Deal Tracker</button>
            <select id="roundupWeekFilter" style="max-width:220px;">
              <option value="">All Weeks</option>
            </select>
          </div>
          <div id="roundupsContainer">
            <p class="muted">Click "Load Deal Tracker" to fetch the latest deals.</p>
          </div>`;
      }

      function renderTemplates(){
        return `
          <div class="twoCols">
            <div class="card" style="padding:14px;">
              <div class="sectionTitle">Downloads</div>
              <p class="muted" style="margin-top:8px;font-size:12px;">Upload files to Supabase Storage and replace the # hrefs below.</p>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <a class="btn primary" href="FinTrend-Portfolio-Tracker.xlsx">Portfolio Tracker</a>
                <a class="btn" href="FinTrend-DCA-Planner.xlsx">DCA Planner</a>
                <a class="btn" href="FinTrend-Earnings-Checklist.xlsx">Earnings Checklist</a>
                <a class="btn" href="FinTrend-Rebalancing-Checklist.xlsx">Rebalancing Checklist</a>
              </div>
            </div>
            <div class="card" style="padding:14px;">
              <div class="sectionTitle">How to use</div>
              <ul class="muted" style="margin:10px 0 0;line-height:1.8;font-size:13px;padding-left:16px;">
                <li><strong style="color:var(--text);">Portfolio Tracker:</strong> performance + contributions + attribution</li>
                <li><strong style="color:var(--text);">DCA Planner:</strong> schedule + target allocation + "what to buy next"</li>
                <li><strong style="color:var(--text);">Earnings Checklist:</strong> forces thesis review before trading</li>
                <li><strong style="color:var(--text);">Rebalancing Checklist:</strong> rules-based, removes emotion</li>
              </ul>
            </div>
          </div>`;
      }

      function renderModels(){
        return `
          <div class="twoCols">
            <div class="card" style="padding:14px;">
              <div class="sectionTitle">Framework Portfolios</div>
              <ul class="muted" style="margin:10px 0 0;line-height:1.8;font-size:13px;padding-left:16px;">
                <li><strong style="color:var(--text);">Cautious:</strong> lower volatility, quality tilt, capital preservation</li>
                <li><strong style="color:var(--text);">Balanced:</strong> core equity + diversifiers, moderate growth</li>
                <li><strong style="color:var(--text);">Aggressive:</strong> growth tilt + tactical sleeve, higher beta</li>
              </ul>
              <p class="note" style="margin-top:10px;">These are illustrative frameworks for educational purposes only. Not financial advice.</p>
            </div>
            <div class="card" style="padding:14px;">
              <div class="sectionTitle">Rebalance Notes</div>
              <p class="muted" style="margin-top:10px;font-size:13px;line-height:1.65;">
                Each rebalance note answers: what changed ‚Üí why now ‚Üí risk ‚Üí what would reverse it.
                Connect to <strong>premium_model_portfolios</strong> table when ready.
              </p>
              <div style="margin-top:12px;">
                <button class="btn primary" data-toast="Connect premium_model_portfolios table to load rebalance notes">View Latest Rebalance</button>
              </div>
            </div>
          </div>`;
      }

      function renderQuantLab(){
        return `
          <div class="chips">
            <div class="chip"><span>Method</span> Mean-Variance Optimization</div>
            <div class="chip"><span>Risk</span> Monte Carlo CVaR</div>
            <div class="chip"><span>Simulations</span> Up to 50,000</div>
          </div>
          <div class="divider"></div>
          <p class="muted" style="font-size:13px;line-height:1.65;margin-bottom:12px;">
            Professional portfolio optimization using the Markowitz framework + Monte Carlo simulation.
            Find optimal weights, then stress-test them with 20,000+ return scenarios.
          </p>
          <button class="btn primary" id="openQuantLabBtn">Open Quant Lab</button>`;
      }

      // =============================================
      // DASHBOARD RENDER
      // =============================================

      function groupByCat(mods){
        const m={};
        for(const mod of mods){ if(!m[mod.category]) m[mod.category]=[]; m[mod.category].push(mod); }
        return m;
      }

      function buildDashboard(selIds){
        const sel = MODULES.filter(m=>selIds.includes(m.id));
        const grouped = groupByCat(MODULES);

        return `<div class="layout">
          <div class="card">
            <div class="sectionTitle">Build your dashboard</div>
            <h2 class="h2">Choose what to see</h2>
            <p class="muted" style="margin-top:8px;font-size:13px;">Your layout saves automatically.</p>
            <div class="divider"></div>
            <div id="selector">
              ${Object.keys(grouped).map(cat=>`
                <div class="card" style="padding:14px;box-shadow:none;margin-bottom:10px;">
                  <div class="sectionTitle">${cat}</div>
                  <div style="margin-top:10px;display:grid;gap:8px;">
                    ${grouped[cat].map(m=>`
                      <label class="check">
                        <input type="checkbox" data-module="${m.id}" ${selIds.includes(m.id)?"checked":""} />
                        <div>
                          <strong>${m.badge}</strong>
                          <small>${m.title}</small>
                        </div>
                      </label>`).join("")}
                  </div>
                </div>`).join("")}
            </div>
            <div class="divider"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn primary" id="selAllBtn">Select All</button>
              <button class="btn" id="selNoneBtn">Select None</button>
              <button class="btn" id="selResetBtn">Reset</button>
            </div>
          </div>

          <div class="modules" id="modulesCol">
            ${sel.length ? sel.map(m=>`
              <div class="card" id="module-${m.id}">
                <div class="moduleHeader">
                  <div>
                    <div class="moduleMeta">
                      <span class="badge">${m.badge}</span>
                      <span class="badge">${m.category}</span>
                    </div>
                    <h3 class="moduleTitle">${m.title}</h3>
                    <p class="moduleDesc">${m.desc}</p>
                  </div>
                  <button class="btn" data-scrolltop>‚Üë Top</button>
                </div>
                <div style="margin-top:12px;">${m.render()}</div>
              </div>`).join("") : `
              <div class="card">
                <div class="sectionTitle">Nothing selected</div>
                <h3 class="moduleTitle" style="margin-top:8px;">Select a module on the left</h3>
              </div>`}
          </div>
        </div>`;
      }

      function rerender(){
        contentEl.innerHTML = buildDashboard(selectedIds);
        wireAll();
      }

      contentEl.style.display = "block";
      contentEl.innerHTML = buildDashboard(selectedIds);
      wireAll();

      // =============================================
      // WIRE ALL EVENTS
      // =============================================

      function wireAll(){
        wireSelectorEvents();
        wireCommonEvents();
        wireDeepDiveEvents();
        wireIdeasEvents(sb);
        wireRoundupsEvents(sb);
        wireQuantLabBtn();
      }

      function wireSelectorEvents(){
        contentEl.querySelectorAll('input[type="checkbox"][data-module]').forEach(cb=>{
          cb.addEventListener("change",()=>{
            const id=cb.getAttribute("data-module");
            if(cb.checked){ if(!selectedIds.includes(id)) selectedIds.push(id); }
            else { selectedIds=selectedIds.filter(x=>x!==id); }
            saveSel(selectedIds);
            rerender();
          });
        });
        const sa=document.getElementById("selAllBtn");
        const sn=document.getElementById("selNoneBtn");
        const sr=document.getElementById("selResetBtn");
        if(sa) sa.onclick=()=>{ selectedIds=MODULES.map(m=>m.id); saveSel(selectedIds); rerender(); };
        if(sn) sn.onclick=()=>{ selectedIds=[]; saveSel(selectedIds); rerender(); };
        if(sr) sr.onclick=()=>{ selectedIds=DEFAULT.slice(); saveSel(selectedIds); rerender(); };
      }

      function wireCommonEvents(){
        contentEl.querySelectorAll("[data-scrolltop]").forEach(b=>{
          b.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"}));
        });
        contentEl.querySelectorAll("[data-toast]").forEach(el=>{
          el.addEventListener("click",()=>alert(el.getAttribute("data-toast")));
        });
      }

      // =============================================
      // DEEP DIVES
      // =============================================
      let ddCache=[];

      async function fetchLatestDD(){
        const {data,error}=await sb.from("premium_articles").select("id,title,content,created_at,sector,tags").eq("type","deep_dive").order("created_at",{ascending:false}).limit(1);
        if(error) throw error;
        return data&&data.length?data[0]:null;
      }
      async function fetchDDArchive(){
        const {data,error}=await sb.from("premium_articles").select("id,title,created_at,sector,tags").eq("type","deep_dive").order("created_at",{ascending:false}).limit(200);
        if(error) throw error;
        return data||[];
      }
      async function fetchDDById(id){
        const {data,error}=await sb.from("premium_articles").select("id,title,content,created_at,sector,tags").eq("id",id).single();
        if(error) throw error;
        return data;
      }

      function enterReader(){
        const s=document.getElementById("ddShell"); if(s) s.classList.add("reading");
        const e=contentEl.querySelector('[data-deepdive="exit"]'); if(e) e.style.display="";
        const b=contentEl.querySelector('[data-deepdive="backToArchive"]'); if(b) b.style.display="";
      }
      function exitReader(){
        const s=document.getElementById("ddShell"); if(s) s.classList.remove("reading");
        const e=contentEl.querySelector('[data-deepdive="exit"]'); if(e) e.style.display="none";
        const b=contentEl.querySelector('[data-deepdive="backToArchive"]'); if(b) b.style.display="none";
      }

      function renderDDViewer(article){
        const v=document.getElementById("ddViewer"); if(!v) return;
        if(!article){ v.innerHTML=`<p class="muted">No deep dives found yet.</p>`; return; }
        const sector=article.sector?`<span class="miniChip">${escHtml(article.sector)}</span>`:"";
        v.innerHTML=`
          <div class="moduleMeta" style="margin-bottom:12px;">
            ${sector}
            <span class="miniChip">${escHtml(fmtDate(article.created_at))}</span>
          </div>
          <h2 style="font-family:'Playfair Display',serif;font-size:26px;margin-bottom:14px;">${escHtml(article.title)}</h2>
          <div class="divider"></div>
          <div class="article-body">${article.content}</div>`;
        enterReader();
      }

      function renderDDList(){
        const list=document.getElementById("ddList");
        const sec=document.getElementById("ddSector");
        const srch=document.getElementById("ddSearch");
        if(!list) return;
        const sv=sec?sec.value:"";
        const q=(srch?srch.value:"").trim().toLowerCase();
        const filtered=ddCache.filter(r=>(!sv||(r.sector===sv))&&(!q||r.title.toLowerCase().includes(q)));
        if(!filtered.length){ list.innerHTML=`<p class="muted">No matches.</p>`; return; }
        list.innerHTML=filtered.map(r=>`
          <div class="archiveRow" data-dd-id="${escHtml(r.id)}">
            <div>
              <div style="font-weight:700;font-size:14px;">${escHtml(r.title)}</div>
              <div class="archiveMeta">
                ${r.sector?`<span class="miniChip">${escHtml(r.sector)}</span>`:""}
              </div>
            </div>
            <div class="muted" style="font-size:12px;white-space:nowrap;">${escHtml(fmtDate(r.created_at))}</div>
          </div>`).join("");
        list.querySelectorAll("[data-dd-id]").forEach(el=>{
          el.addEventListener("click",async()=>{
            const id=el.getAttribute("data-dd-id");
            const v=document.getElementById("ddViewer");
            if(v) v.innerHTML=`<p class="muted loadingPulse">Loading‚Ä¶</p>`;
            try{ renderDDViewer(await fetchDDById(id)); }
            catch(err){ alert("Could not load: "+(err?.message||String(err))); }
          });
        });
      }

      async function refreshArchive(){
        ddCache=await fetchDDArchive();
        const sec=document.getElementById("ddSector");
        if(sec){
          const sectors=[...new Set(ddCache.filter(r=>r.sector).map(r=>r.sector))].sort();
          const cur=sec.value;
          sec.innerHTML=`<option value="">All sectors</option>`+sectors.map(s=>`<option value="${escHtml(s)}">${escHtml(s)}</option>`).join("");
          if(sectors.includes(cur)) sec.value=cur;
          sec.onchange=()=>renderDDList();
        }
        const srch=document.getElementById("ddSearch");
        if(srch) srch.oninput=()=>renderDDList();
        renderDDList();
      }

      function wireDeepDiveEvents(){
        const latBtn=contentEl.querySelector('[data-deepdive="latest"]');
        const arcBtn=contentEl.querySelector('[data-deepdive="archive"]');
        const refBtn=contentEl.querySelector('[data-deepdive="refresh"]');
        const exitBtn=contentEl.querySelector('[data-deepdive="exit"]');
        const backBtn=contentEl.querySelector('[data-deepdive="backToArchive"]');

        if(latBtn) latBtn.onclick=async()=>{
          const v=document.getElementById("ddViewer");
          if(v) v.innerHTML=`<p class="muted loadingPulse">Loading latest‚Ä¶</p>`;
          try{ renderDDViewer(await fetchLatestDD()); }
          catch(err){ alert("Error: "+(err?.message||String(err))); }
        };
        if(arcBtn) arcBtn.onclick=async()=>{
          exitReader();
          const l=document.getElementById("ddList");
          if(l) l.innerHTML=`<p class="muted loadingPulse">Loading archive‚Ä¶</p>`;
          try{ await refreshArchive(); }
          catch(err){ alert("Error: "+(err?.message||String(err))); }
        };
        if(refBtn) refBtn.onclick=async()=>{
          exitReader();
          try{ await refreshArchive(); }
          catch(err){ alert("Error: "+(err?.message||String(err))); }
        };
        if(exitBtn) exitBtn.onclick=()=>exitReader();
        if(backBtn) backBtn.onclick=async()=>{
          exitReader();
          if(!ddCache.length){ try{ await refreshArchive(); }catch{} }
        };
      }

      // =============================================
      // IDEAS ‚Äî wired to premium_ideas
      // =============================================
      function wireIdeasEvents(sbClient){
        const loadBtn=document.getElementById("loadIdeasBtn");
        const container=document.getElementById("ideasContainer");
        const sectorFilter=document.getElementById("ideasSectorFilter");
        if(!loadBtn||!container) return;

        let ideasCache=[];

        function renderIdeasCards(){
          const sv=sectorFilter?sectorFilter.value:"";
          const filtered=ideasCache.filter(i=>!sv||(i.sector===sv));
          if(!filtered.length){
            container.innerHTML=`<p class="muted">No ideas found. Add some in Supabase ‚Üí premium_ideas.</p>`;
            return;
          }
          container.innerHTML=`<div class="ideaGrid">${filtered.map(idea=>`
            <div class="ideaCard">
              <div class="ideaTicker">${escHtml(idea.ticker||"‚Äî")}</div>
              <div class="ideaSector">${escHtml(idea.sector||"")} ${idea.horizon?`¬∑ ${escHtml(idea.horizon)}`:""}
                <span class="miniChip" style="margin-left:6px;">${escHtml(fmtDate(idea.created_at))}</span>
              </div>
              ${idea.thesis?`<div class="ideaRow"><div class="ideaLabel">Thesis</div><div class="ideaText">${escHtml(idea.thesis)}</div></div>`:""}
              ${idea.catalysts?`<div class="ideaRow"><div class="ideaLabel">Catalysts</div><div class="ideaText">${escHtml(idea.catalysts)}</div></div>`:""}
              ${idea.risk_note?`<div class="ideaRow"><div class="ideaLabel">Risk</div><div class="ideaText">${escHtml(idea.risk_note)}</div></div>`:""}
            </div>`).join("")}</div>`;
        }

        loadBtn.onclick=async()=>{
          container.innerHTML=`<p class="muted loadingPulse">Loading ideas‚Ä¶</p>`;
          loadBtn.disabled=true;
          try{
            const {data,error}=await sbClient
              .from("premium_ideas")
              .select("*")
              .order("created_at",{ascending:false});
            if(error) throw error;
            ideasCache=data||[];

            // Populate sector filter
            if(sectorFilter){
              const sectors=[...new Set(ideasCache.filter(i=>i.sector).map(i=>i.sector))].sort();
              sectorFilter.innerHTML=`<option value="">All Sectors</option>`+sectors.map(s=>`<option value="${escHtml(s)}">${escHtml(s)}</option>`).join("");
              sectorFilter.onchange=()=>renderIdeasCards();
            }
            renderIdeasCards();
          }catch(err){
            container.innerHTML=`<p style="color:#f87171;">Failed to load ideas: ${escHtml(err?.message||String(err))}</p>`;
          } finally {
            loadBtn.disabled=false;
          }
        };
      }

      // =============================================
      // DEAL TRACKER ‚Äî wired to premium_roundups
      // =============================================
      const DEAL_TYPE_COLORS = {
        "LBO":  { bg:"rgba(244,193,93,0.12)",  border:"rgba(244,193,93,0.45)",  text:"#f4c15d" },
        "M&A":  { bg:"rgba(147,197,253,0.12)", border:"rgba(147,197,253,0.45)", text:"#93c5fd" },
        "IPO":  { bg:"rgba(110,231,183,0.12)", border:"rgba(110,231,183,0.45)", text:"#6ee7b7" },
      };

      function dealTypeBadge(type){
        const t=(type||"").toUpperCase();
        const c=DEAL_TYPE_COLORS[t]||{bg:"rgba(148,163,184,0.12)",border:"rgba(148,163,184,0.35)",text:"#9ca3af"};
        return `<span style="display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid ${c.border};background:${c.bg};color:${c.text};font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;">${escHtml(t||"DEAL")}</span>`;
      }

      function renderOneDeal(ticker, type, title, body, view, risk){
        if(!title && !body) return "";
        return `
          <div style="border:1px solid rgba(148,163,184,0.2);background:rgba(2,6,23,0.35);border-radius:16px;padding:18px;margin-bottom:12px;transition:border-color .15s;" onmouseover="this.style.borderColor='rgba(244,193,93,0.3)'" onmouseout="this.style.borderColor='rgba(148,163,184,0.2)'">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                ${ticker ? `<div style="font-family:'Playfair Display',serif;font-size:26px;color:var(--brand);line-height:1;min-width:48px;">${escHtml(ticker)}</div>` : ""}
                <div>
                  ${dealTypeBadge(type)}
                  <div style="font-size:16px;font-weight:700;margin-top:5px;color:var(--text);">${escHtml(title||"")}</div>
                </div>
              </div>
            </div>
            ${body ? `
              <div style="font-size:13px;color:#d1d5db;line-height:1.65;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(148,163,184,0.12);">
                ${escHtml(body)}
              </div>` : ""}
            ${view ? `
              <div style="display:flex;gap:10px;margin-bottom:10px;">
                <div style="font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--brand);padding:3px 8px;border-radius:999px;border:1px solid rgba(244,193,93,0.3);background:rgba(244,193,93,0.06);flex-shrink:0;margin-top:2px;white-space:nowrap;">Our View</div>
                <div style="font-size:13px;color:#e5e7eb;line-height:1.55;">${escHtml(view)}</div>
              </div>` : ""}
            ${risk ? `
              <div style="display:flex;gap:10px;">
                <div style="font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:#f87171;padding:3px 8px;border-radius:999px;border:1px solid rgba(248,113,113,0.3);background:rgba(248,113,113,0.06);flex-shrink:0;margin-top:2px;white-space:nowrap;">Key Risk</div>
                <div style="font-size:13px;color:#fca5a5;line-height:1.55;">${escHtml(risk)}</div>
              </div>` : ""}
          </div>`;
      }

      function wireRoundupsEvents(sbClient){
        const loadBtn=document.getElementById("loadRoundupsBtn");
        const container=document.getElementById("roundupsContainer");
        const weekFilter=document.getElementById("roundupWeekFilter");
        if(!loadBtn||!container) return;

        let roundupsCache=[];

        function renderDealTrackerCards(){
          const wv=weekFilter?weekFilter.value:"";
          const filtered=roundupsCache.filter(r=>!wv||(r.title===wv));
          if(!filtered.length){
            container.innerHTML=`<p class="muted">No Deal Tracker entries found. Add some in Supabase ‚Üí premium_roundups.</p>`;
            return;
          }
          container.innerHTML=filtered.map(r=>`
            <div style="margin-bottom:20px;">
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px;">
                <div style="font-family:'Playfair Display',serif;font-size:19px;color:var(--text);">${escHtml(r.title||"Deal Tracker")}</div>
                <span class="miniChip">${escHtml(fmtDate(r.created_at))}</span>
                ${r.period?`<span class="miniChip">${escHtml(r.period)}</span>`:""}
              </div>
              ${renderOneDeal(r.deal1_ticker,r.deal1_type,r.deal1_title,r.deal1_body,r.deal1_view,r.deal1_risk)}
              ${renderOneDeal(r.deal2_ticker,r.deal2_type,r.deal2_title,r.deal2_body,r.deal2_view,r.deal2_risk)}
              ${renderOneDeal(r.deal3_ticker,r.deal3_type,r.deal3_title,r.deal3_body,r.deal3_view,r.deal3_risk)}
            </div>`).join('<div style="height:1px;background:rgba(148,163,184,0.15);margin:8px 0 20px;"></div>');
        }

        loadBtn.onclick=async()=>{
          container.innerHTML=`<p class="muted loadingPulse">Loading deals‚Ä¶</p>`;
          loadBtn.disabled=true;
          try{
            const {data,error}=await sbClient
              .from("premium_roundups")
              .select("*")
              .order("created_at",{ascending:false});
            if(error) throw error;
            roundupsCache=data||[];

            if(weekFilter){
              const weeks=[...new Set(roundupsCache.map(r=>r.title).filter(Boolean))];
              weekFilter.innerHTML=`<option value="">All Weeks</option>`+weeks.map(w=>`<option value="${escHtml(w)}">${escHtml(w)}</option>`).join("");
              weekFilter.onchange=()=>renderDealTrackerCards();
            }
            renderDealTrackerCards();
          }catch(err){
            container.innerHTML=`<p style="color:#f87171;">Failed to load deals: ${escHtml(err?.message||String(err))}</p>`;
          } finally {
            loadBtn.disabled=false;
          }
        };
      }

      // =============================================
      // QUANT LAB ‚Äî popup flow
      // =============================================
      function wireQuantLabBtn(){
        const btn=document.getElementById("openQuantLabBtn");
        if(btn) btn.onclick=()=>{
          document.getElementById("qlExplainer").classList.add("active");
        };
      }

      // Explainer modal events
      document.getElementById("qlExplainerClose").onclick=()=>{
        document.getElementById("qlExplainer").classList.remove("active");
      };
      document.getElementById("qlNevermind").onclick=()=>{
        document.getElementById("qlExplainer").classList.remove("active");
      };
      document.getElementById("qlOpenCalc").onclick=()=>{
        document.getElementById("qlExplainer").classList.remove("active");
        document.getElementById("qlCalc").classList.add("active");
        initCalc();
      };

      // Calc modal close
      document.getElementById("qlCalcClose").onclick=()=>{
        document.getElementById("qlCalc").classList.remove("active");
      };

      // Close on backdrop click
      document.getElementById("qlExplainer").addEventListener("click",e=>{
        if(e.target===document.getElementById("qlExplainer"))
          document.getElementById("qlExplainer").classList.remove("active");
      });
      document.getElementById("qlCalc").addEventListener("click",e=>{
        if(e.target===document.getElementById("qlCalc"))
          document.getElementById("qlCalc").classList.remove("active");
      });

      // ESC to close
      window.addEventListener("keydown",e=>{
        if(e.key==="Escape"){
          document.getElementById("qlExplainer").classList.remove("active");
          document.getElementById("qlCalc").classList.remove("active");
        }
      });

      // =============================================
      // QUANT CALCULATOR
      // =============================================
      const ASSET_COLORS=["#f4c15d","#93c5fd","#6ee7b7","#f87171","#c084fc"];
      let numAssets=3;
      let calcInited=false;

      function initCalc(){
        if(calcInited) return;
        calcInited=true;
        renderAssetRows();
        renderCorrGrid();

        document.getElementById("addAssetBtn").onclick=()=>{
          if(numAssets>=5) return;
          numAssets++;
          renderAssetRows();
          renderCorrGrid();
        };
        document.getElementById("removeAssetBtn").onclick=()=>{
          if(numAssets<=2) return;
          numAssets--;
          renderAssetRows();
          renderCorrGrid();
        };
        document.getElementById("loadExampleBtn").onclick=loadExample;
        document.getElementById("resetCalcBtn").onclick=resetCalc;
        document.getElementById("runOptBtn").onclick=runOptimizer;
      }

      function renderAssetRows(){
        const container=document.getElementById("assetRows");
        const names=["Asset 1","Asset 2","Asset 3","Asset 4","Asset 5"];
        let html="";
        for(let i=0;i<numAssets;i++){
          const existing=container?container.querySelector(`#assetName_${i}`)?.value:null;
          const mu=container?container.querySelector(`#assetMu_${i}`)?.value:null;
          const sig=container?container.querySelector(`#assetSig_${i}`)?.value:null;
          html+=`<div class="qlAssetRow">
            <div class="qlAssetLabel" style="color:${ASSET_COLORS[i]};">Asset ${i+1}</div>
            <input type="text" id="assetName_${i}" placeholder="${names[i]}" value="${existing||""}" />
            <input type="number" id="assetMu_${i}" placeholder="0.10" step="0.01" value="${mu||""}" />
            <input type="number" id="assetSig_${i}" placeholder="0.20" step="0.01" value="${sig||""}" />
          </div>`;
        }
        container.innerHTML=html;
      }

      function renderCorrGrid(){
        const container=document.getElementById("corrGrid");
        if(numAssets<2){ container.innerHTML=""; return; }
        // Build upper triangle correlation inputs
        let html=`<table style="border-collapse:separate;border-spacing:6px;">`;
        // Header row
        html+=`<tr><td></td>`;
        for(let j=0;j<numAssets;j++){
          html+=`<td style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:${ASSET_COLORS[j]};text-align:center;padding:4px;">A${j+1}</td>`;
        }
        html+=`</tr>`;
        for(let i=0;i<numAssets;i++){
          html+=`<tr><td style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:${ASSET_COLORS[i]};padding:4px;">A${i+1}</td>`;
          for(let j=0;j<numAssets;j++){
            if(i===j){
              html+=`<td><input type="number" value="1" readonly style="width:70px;background:rgba(244,193,93,0.08);border-color:rgba(244,193,93,0.2);text-align:center;cursor:not-allowed;opacity:.6;" /></td>`;
            } else if(j>i){
              const existing=document.getElementById(`corr_${i}_${j}`)?.value;
              html+=`<td><input type="number" id="corr_${i}_${j}" placeholder="0.30" step="0.05" min="-1" max="1" value="${existing||""}" style="width:70px;text-align:center;" /></td>`;
            } else {
              html+=`<td><input type="number" value="‚Äî" readonly style="width:70px;opacity:.3;cursor:not-allowed;" /></td>`;
            }
          }
          html+=`</tr>`;
        }
        html+=`</table>`;
        container.innerHTML=html;
      }

      function loadExample(){
        numAssets=3;
        renderAssetRows();
        renderCorrGrid();
        // Names
        ["SPX","Bonds","Gold"].forEach((n,i)=>{ const el=document.getElementById(`assetName_${i}`); if(el) el.value=n; });
        // Returns
        [0.10,0.04,0.06].forEach((v,i)=>{ const el=document.getElementById(`assetMu_${i}`); if(el) el.value=v; });
        // Vols
        [0.18,0.06,0.14].forEach((v,i)=>{ const el=document.getElementById(`assetSig_${i}`); if(el) el.value=v; });
        // Corrs
        const corrs={corr_0_1:-0.2,corr_0_2:0.05,corr_1_2:0.1};
        Object.entries(corrs).forEach(([id,v])=>{ const el=document.getElementById(id); if(el) el.value=v; });
        document.getElementById("lambdaInput").value=4;
        document.getElementById("simCount").value=20000;
        hideError();
        document.getElementById("qlResults").style.display="none";
      }

      function resetCalc(){
        numAssets=3;
        renderAssetRows();
        renderCorrGrid();
        document.getElementById("lambdaInput").value=4;
        document.getElementById("simCount").value=20000;
        hideError();
        document.getElementById("qlResults").style.display="none";
      }

      function showError(msg){
        const el=document.getElementById("qlError");
        el.textContent=msg; el.style.display="block";
      }
      function hideError(){
        const el=document.getElementById("qlError");
        el.style.display="none"; el.textContent="";
      }

      function getInputs(){
        const mu=[], sig=[], names=[];
        for(let i=0;i<numAssets;i++){
          const n=document.getElementById(`assetName_${i}`)?.value||`Asset ${i+1}`;
          const m=parseFloat(document.getElementById(`assetMu_${i}`)?.value);
          const s=parseFloat(document.getElementById(`assetSig_${i}`)?.value);
          if(!Number.isFinite(m)||!Number.isFinite(s)) throw new Error(`Asset ${i+1}: enter valid return and volatility.`);
          if(s<=0) throw new Error(`Asset ${i+1}: volatility must be > 0.`);
          names.push(n); mu.push(m); sig.push(s);
        }
        // Build covariance matrix from correlations + vols
        const Sigma=Array.from({length:numAssets},(_,i)=>Array.from({length:numAssets},(_,j)=>{
          if(i===j) return sig[i]*sig[i];
          const key1=`corr_${Math.min(i,j)}_${Math.max(i,j)}`;
          const rho=parseFloat(document.getElementById(key1)?.value);
          if(!Number.isFinite(rho)||rho<-1||rho>1) throw new Error(`Correlation A${Math.min(i,j)+1}/A${Math.max(i,j)+1}: enter a value between -1 and 1.`);
          return rho*sig[i]*sig[j];
        }));
        const lambda=parseFloat(document.getElementById("lambdaInput")?.value);
        const nSim=parseInt(document.getElementById("simCount")?.value)||20000;
        if(!Number.isFinite(lambda)||lambda<=0) throw new Error("Risk aversion Œª must be > 0.");
        return {mu, sig, Sigma, names, lambda, nSim};
      }

      // Math utilities
      function matVecN(A,v){
        return A.map(row=>row.reduce((s,a,j)=>s+a*v[j],0));
      }
      function dotN(a,b){ return a.reduce((s,x,i)=>s+x*b[i],0); }

      function invN(A){
        const n=A.length;
        const aug=A.map((r,i)=>[...r,...Array.from({length:n},(_,j)=>i===j?1:0)]);
        for(let col=0;col<n;col++){
          let pivot=-1,pv=0;
          for(let row=col;row<n;row++) if(Math.abs(aug[row][col])>pv){pv=Math.abs(aug[row][col]);pivot=row;}
          if(pv<1e-12) throw new Error("Matrix is singular ‚Äî check correlations (no perfect collinearity).");
          [aug[col],aug[pivot]]=[aug[pivot],aug[col]];
          const sc=aug[col][col];
          aug[col]=aug[col].map(x=>x/sc);
          for(let row=0;row<n;row++){
            if(row!==col){
              const f=aug[row][col];
              aug[row]=aug[row].map((x,k)=>x-f*aug[col][k]);
            }
          }
        }
        return aug.map(r=>r.slice(n));
      }

      function projectSimplexN(v){
        let x=v.map(a=>Math.max(0,a));
        for(let k=0;k<10;k++){
          const s=x.reduce((a,b)=>a+b,0);
          x=s>1e-12?x.map(a=>a/s):x.map(()=>1/x.length);
        }
        return x;
      }

      function cholN(S){
        const n=S.length;
        const L=Array.from({length:n},()=>new Array(n).fill(0));
        for(let i=0;i<n;i++){
          for(let j=0;j<=i;j++){
            let s=S[i][j];
            for(let k=0;k<j;k++) s-=L[i][k]*L[j][k];
            if(i===j){
              if(s<=0) throw new Error("Covariance matrix is not positive definite. Check your correlations ‚Äî they may be inconsistent.");
              L[i][j]=Math.sqrt(s);
            } else { L[i][j]=s/L[j][j]; }
          }
        }
        return L;
      }

      function randn(){
        let u=0,v=0;
        while(u===0) u=Math.random();
        while(v===0) v=Math.random();
        return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
      }

      function runMonteCarlo(mu,L,w,nSim){
        const n=mu.length;
        const port=new Float64Array(nSim);
        for(let s=0;s<nSim;s++){
          let ret=0;
          const z=Array.from({length:n},()=>randn());
          for(let i=0;i<n;i++){
            let ri=mu[i];
            for(let k=0;k<=i;k++) ri+=L[i][k]*z[k];
            ret+=w[i]*ri;
          }
          port[s]=ret;
        }
        port.sort((a,b)=>a-b);
        const alpha=0.05;
        const idx=Math.floor(alpha*nSim);
        const var95=port[idx];
        const tail=Array.from(port.slice(0,idx+1));
        const cvar95=tail.reduce((a,b)=>a+b,0)/tail.length;
        const mean=Array.from(port).reduce((a,b)=>a+b,0)/nSim;
        const std=Math.sqrt(Array.from(port).reduce((a,b)=>a+(b-mean)*(b-mean),0)/nSim);
        return {mean,std,var95,cvar95};
      }

      function fmtPct(x,dec=2){ return (x*100).toFixed(dec)+"%"; }
      function fmtRatio(x){ return x.toFixed(2); }

      function runOptimizer(){
        hideError();
        const btn=document.getElementById("runOptBtn");
        btn.innerHTML=`<span class="qlSpinner"></span>Running‚Ä¶`;
        btn.disabled=true;

        setTimeout(()=>{
          try{
            const {mu,sig,Sigma,names,lambda,nSim}=getInputs();
            const SigInv=invN(Sigma);
            const raw=matVecN(SigInv,mu).map(v=>v/lambda);
            const w=projectSimplexN(raw);

            const portMu=dotN(w,mu);
            const sigW=matVecN(Sigma,w);
            const portVar=dotN(w,sigW);
            const portVol=Math.sqrt(Math.max(0,portVar));
            const sharpe=(portVol>1e-10)?portMu/portVol:0;

            const L=cholN(Sigma);
            const mc=runMonteCarlo(mu,L,w,nSim);

            // Render results
            const resEl=document.getElementById("qlResults");
            resEl.style.display="block";

            // Weight bar
            const wb=document.getElementById("weightBar");
            wb.innerHTML=w.map((wi,i)=>`<div class="qlWeightBarSeg" style="width:${(wi*100).toFixed(1)}%;background:${ASSET_COLORS[i]};"></div>`).join("");

            // Weight legend
            const wl=document.getElementById("weightLegend");
            wl.innerHTML=w.map((wi,i)=>`
              <div class="qlWeightLegendItem">
                <div class="qlWeightLegendDot" style="background:${ASSET_COLORS[i]};"></div>
                ${escHtml(names[i])}: <strong>${fmtPct(wi,1)}</strong>
              </div>`).join("");

            // Result cells
            const cells=[
              {label:"Expected Return",value:fmtPct(portMu),sub:"Annualized"},
              {label:"Volatility",value:fmtPct(portVol),sub:"Annualized"},
              {label:"Sharpe Ratio",value:fmtRatio(sharpe),sub:"Return / Vol"},
              {label:"95% VaR",value:fmtPct(mc.var95),sub:"1-year horizon"},
              {label:"95% CVaR",value:fmtPct(mc.cvar95),sub:"Avg worst 5%"},
              {label:"MC Mean Return",value:fmtPct(mc.mean),sub:`${nSim.toLocaleString()} scenarios`},
            ];
            document.getElementById("resultCells").innerHTML=cells.map(c=>`
              <div class="qlResultCell">
                <div class="qlResultCellLabel">${c.label}</div>
                <div class="qlResultCellValue">${c.value}</div>
                <div class="qlResultCellSub">${c.sub}</div>
              </div>`).join("");

            // MC details
            document.getElementById("mcDetails").textContent=
`Optimal Weights:
${w.map((wi,i)=>`  ${names[i].padEnd(14)} ${fmtPct(wi,2)}`).join("\n")}

Analytic Portfolio:
  Expected Return  ${fmtPct(portMu)}
  Volatility       ${fmtPct(portVol)}
  Sharpe Ratio     ${fmtRatio(sharpe)}

Monte Carlo (${nSim.toLocaleString()} scenarios):
  Mean Return      ${fmtPct(mc.mean)}
  Std Dev          ${fmtPct(mc.std)}
  95% VaR          ${fmtPct(mc.var95)}   ‚Üê worst 5th percentile return
  95% CVaR         ${fmtPct(mc.cvar95)}   ‚Üê avg return in worst 5%

Disclaimer: Educational only. Not financial advice.`;

            resEl.scrollIntoView({behavior:"smooth",block:"nearest"});

          }catch(err){
            showError(err?.message||String(err));
          }finally{
            btn.innerHTML="Run Optimization";
            btn.disabled=false;
          }
        },50);
      }

    } catch(e){
      console.error("[premium] fatal:",e);
      showFatal("Fatal error","The page crashed before finishing.",e?.message||String(e));
    }
  })();
  </script>
</body>
</html>
