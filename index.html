<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FinTrend News | Market Newsletter</title>

  <link rel="icon" type="image/png" href="assets/img/favicon.png" />
  <link rel="apple-touch-icon" href="assets/img/favicon.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- GA (unchanged) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KSK5YVPJBR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KSK5YVPJBR');
  </script>

  <!-- Supabase (unchanged) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050816;
      --bg-elevated:#0b1020;
      --accent:#f4c15d;
      --accent-soft:rgba(244,193,93,0.12);
      --text-main:#f9fafb;
      --text-muted:#9ca3af;
      --border-subtle:rgba(148,163,184,0.35);
      --radius-lg:18px;
      --radius-xl:24px;
      --shadow-soft:0 18px 45px rgba(15, 23, 42, 0.8);
      --max-width:980px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{color:var(--text-main)}
    body{
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      line-height:1.6;
      min-height:100vh;
      background-image:
        radial-gradient(circle at top, rgba(17, 24, 39, 0.78) 0, rgba(2, 6, 23, 0.82) 45%, rgba(0, 0, 0, 0.92) 100%),
        url("assets/img/bg-candles.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(to bottom, rgba(2,6,23,0.18), rgba(2,6,23,0.35) 40%, rgba(2,6,23,0.60));
      pointer-events:none;
      z-index:-1;
    }

    a{color:#e5e7eb;text-decoration:none}
    a:hover{color:var(--accent)}

    .page{
      max-width:var(--max-width);
      margin:18px auto 70px;
      padding:0 16px 42px;
    }

    /* Header (clean) */
    .top-header{
      position:sticky;
      top:0;
      z-index:9999;
      border-radius:var(--radius-xl);
      background:linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.82));
      border:1px solid rgba(148, 163, 184, 0.25);
      box-shadow:0 8px 24px rgba(15, 23, 42, 0.6);
      overflow:hidden;
      margin-bottom:18px;
      backdrop-filter:blur(6px);
    }

    .header-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .logo-img{height:44px;width:auto;display:block}
    .brand-text{min-width:0}
    .brand-title{
      font-family:"Playfair Display","Times New Roman",serif;
      font-size:24px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:var(--accent);
      line-height:1.05;
      white-space:nowrap;
    }
    .brand-subtitle{
      margin-top:4px;
      font-size:11px;
      color:var(--text-muted);
      letter-spacing:0.10em;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .header-link{
      font-size:12px;
      color:var(--text-muted);
      letter-spacing:0.08em;
      text-transform:uppercase;
      transition:0.2s ease;
      white-space:nowrap;
    }
    .header-link:hover{color:var(--text-main)}

    .primary-btn{
      padding:9px 14px;
      border-radius:999px;
      background:var(--accent);
      color:#000 !important;
      font-size:12px;
      font-weight:900;
      letter-spacing:0.10em;
      text-transform:uppercase;
      transition:0.2s ease;
      border:none;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(244,193,93,0.15);
      white-space:nowrap;
    }
    .primary-btn:hover{background:#f7d680;transform:translateY(-1px)}

    /* User chip */
    .user-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.28);
      background:rgba(2,6,23,0.35);
      color:var(--text-muted);
      max-width:320px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .user-chip .uc-dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(148,163,184,0.45);
      box-shadow:0 0 0 4px rgba(148,163,184,0.10);
      flex:0 0 auto;
    }
    .user-chip.premium .uc-dot{
      background:rgba(147,197,253,0.95);
      box-shadow:0 0 0 4px rgba(147,197,253,0.12);
    }

    /* Hero (minimal) */
    .hero{
      padding:18px 0 0;
    }
    .hero-card{
      border-radius:var(--radius-xl);
      border:1px solid rgba(148, 163, 184, 0.22);
      background:rgba(15, 23, 42, 0.72);
      box-shadow:0 18px 45px rgba(15, 23, 42, 0.75);
      overflow:hidden;
      backdrop-filter:blur(8px);
      position:relative;
      padding:26px 22px 22px;
    }
    .hero-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top left, rgba(244,193,93,0.10), transparent 55%);
      pointer-events:none;
    }
    .hero-inner{
      position:relative;
      z-index:1;
      max-width:720px;
      margin:0 auto;
      text-align:center;
    }
    .hero-title{
      font-family:"Playfair Display","Times New Roman",serif;
      font-size:44px;
      line-height:1.08;
      margin-bottom:10px;
    }
    .hero-title span{
      background:linear-gradient(135deg, #fef3c7, #fbbf24, #fb923c);
      -webkit-background-clip:text;
      color:transparent;
    }
    .hero-sub{
      color:#e5e7eb;
      font-size:15px;
      line-height:1.6;
      margin:0 auto 18px;
      max-width:62ch;
    }

    .cta-row{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top:8px;
    }

    .reassure{
      font-size:12px;
      color:var(--text-muted);
      letter-spacing:0.02em;
    }

    .secondary-link{
      font-size:12px;
      color:var(--text-muted);
      letter-spacing:0.10em;
      text-transform:uppercase;
      text-decoration:none;
      border-bottom:1px solid transparent;
      transition:0.18s ease;
    }
    .secondary-link:hover{
      color:#e5e7eb;
      border-bottom-color:rgba(244,193,93,0.35);
    }

    /* Small sections */
    .panel{
      margin-top:16px;
      border-radius:var(--radius-xl);
      border:1px solid var(--border-subtle);
      background:rgba(15, 23, 42, 0.90);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 14px;
      position:relative;
      overflow:hidden;
      backdrop-filter:blur(6px);
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top left, rgba(250, 204, 21, 0.06), transparent 55%);
      pointer-events:none;
    }
    .panel > *{position:relative;z-index:1}

    .panel-head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .panel-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-muted);
    }

    .two-col{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:840px){
      .two-col{grid-template-columns:1fr}
      .hero-title{font-size:36px}
      .brand-title{font-size:22px}
      .brand-subtitle{display:none}
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.26);
      background:rgba(2,6,23,0.34);
      padding:14px 14px 12px;
      overflow:hidden;
    }
    .card h3{
      font-size:14px;
      color:#e5e7eb;
      margin-bottom:8px;
      letter-spacing:0.02em;
    }
    .bullets{
      margin:0 0 0 16px;
      color:#d1d5db;
      font-size:12px;
      line-height:1.6;
    }
    .bullets li{margin:0 0 6px}

    .tiny{
      margin-top:10px;
      font-size:11px;
      color:var(--text-muted);
    }

    /* Premium mini section */
    .premium-mini{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .premium-mini strong{
      color:#e5e7eb;
      font-size:13px;
      letter-spacing:0.02em;
    }
    .premium-mini span{
      color:var(--text-muted);
      font-size:12px;
    }
    .mini-btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.30);
      background:rgba(2,6,23,0.40);
      color:#e5e7eb;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      cursor:pointer;
      transition:0.18s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .mini-btn:hover{transform:translateY(-1px);border-color:rgba(244,193,93,0.35);color:var(--accent)}

    footer{
      margin-top:18px;
      font-size:11px;
      color:var(--text-muted);
      text-align:center;
      opacity:0.9;
    }
    footer a{color:var(--accent)}
    footer a:hover{text-decoration:underline}

    /* Modals */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      padding:14px;
    }
    .modal-backdrop.active{display:flex}
    .modal-window{
      background:rgba(15, 23, 42, 0.97);
      border-radius:24px;
      border:1px solid rgba(148, 163, 184, 0.35);
      box-shadow:0 18px 45px rgba(15, 23, 42, 0.8);
      max-width:460px;
      width:100%;
      padding:22px 22px 18px;
      position:relative;
    }
    .modal-close{
      position:absolute;
      top:10px;
      right:12px;
      border:none;
      background:transparent;
      color:#9ca3af;
      font-size:20px;
      cursor:pointer;
    }
    .modal-kicker{font-size:11px;text-transform:uppercase;letter-spacing:0.18em;color:#9ca3af;margin-bottom:4px}
    .modal-title{font-family:"Playfair Display",serif;font-size:22px;margin-bottom:6px;color:#f9fafb}
    .modal-subtitle{font-size:13px;color:#d1d5db;margin-bottom:12px}
    .modal-btn-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .modal-primary-btn,.modal-secondary-btn{
      border-radius:999px;
      font-size:12px;
      padding:10px 16px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:0.2s ease;
      border:none;
    }
    .modal-primary-btn{background:#f4c15d;color:#000;font-weight:900}
    .modal-primary-btn:hover{background:#f7d680}
    .modal-secondary-btn{
      border:1px solid rgba(148,163,184,0.5);
      background:transparent;
      color:#9ca3af;
    }
    .modal-secondary-btn:hover{border-color:#f4c15d;color:#f4c15d}

    /* Auth inputs */
    .auth-form{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .auth-input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.40);
      background:#020617;
      color:#f9fafb;
      font-size:13px;
      outline:none;
    }
    .auth-input:focus{border-color:rgba(244,193,93,0.6);box-shadow:0 0 0 4px rgba(244,193,93,0.10)}
    .auth-msg{margin-top:6px;font-size:12px;color:#e5e7eb;min-height:18px}
    .auth-hint{font-size:11px;color:var(--text-muted);margin-top:8px}

    /* Premium status line */
    .status-line{
      font-size:11px;
      color:var(--text-muted);
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div class="page">
    <header class="top-header">
      <div class="header-main">
        <div class="brand">
          <img src="assets/img/FTN-logo.png" alt="FinTrend News logo" class="logo-img">
          <div class="brand-text">
            <div class="brand-title">FinTrend News</div>
            <div class="brand-subtitle">Market briefs & deep dives</div>
          </div>
        </div>

        <div class="header-actions">
          <a href="archive.html" class="header-link">Read Free Articles</a>

          <!-- Premium (kept, same gating logic, but not loud) -->
          <a href="#" class="header-link" id="nav-premium">Premium</a>

          <!-- Auth -->
          <button class="primary-btn" id="open-auth-modal" type="button">Create Free Account</button>
          <a href="#" class="header-link" id="signout-link" style="display:none;">Sign Out</a>

          <span class="user-chip" id="user-chip" style="display:none;">
            <span class="uc-dot" aria-hidden="true"></span>
            <span id="user-chip-text">Signed in</span>
          </span>
        </div>
      </div>
    </header>

    <!-- HERO (minimal) -->
    <section class="hero" id="top">
      <div class="hero-card">
        <div class="hero-inner">
          <h1 class="hero-title">A <span>clean market brief</span> for fast decisions.</h1>
          <p class="hero-sub">Context, key levels, and catalyst scenarios — without the noise.</p>

          <div class="cta-row">
            <!-- Link stays "exactly the same": opens the same auth modal -->
            <button class="primary-btn" id="hero-create-account" type="button">Create Free Account</button>

            <div class="reassure">No credit card • Email used for login</div>

            <a class="secondary-link" href="archive.html">Read Free Articles</a>
          </div>
        </div>
      </div>
    </section>

    <!-- WHY ACCOUNT (bullets, not paragraphs) -->
    <section class="panel" aria-label="Why create an account">
      <div class="panel-head">
        <div class="panel-title">Why create an account</div>
      </div>

      <div class="two-col">
        <div class="card">
          <h3>Fewer distractions</h3>
          <ul class="bullets">
            <li>Sign in once, stay signed in.</li>
            <li>Some free articles include an account gate after the teaser.</li>
            <li>No email marketing yet — just login access.</li>
          </ul>
          <div class="tiny">You can still read the free library without an account.</div>
        </div>

        <div class="card">
          <h3>What happens right now</h3>
          <ul class="bullets">
            <li>You create an email + password.</li>
            <li>That email becomes your login.</li>
            <li>No newsletter sending in this phase.</li>
          </ul>
          <div class="tiny">Later: opt-in + unsubscribe + sending (not in this build).</div>
        </div>
      </div>
    </section>

    <!-- PREMIUM (small, clear, unchanged logic) -->
    <section class="panel" id="premium" aria-label="Premium Deep Dives">
      <div class="panel-head">
        <div class="panel-title">Premium Deep Dives</div>
      </div>

      <div class="premium-mini">
        <div>
          <strong>Premium Deep Dives</strong><br/>
          <span>Members dashboard (premium.html) with tools & deep dive modules.</span>
          <div class="status-line" id="premium-status">Sign in to check access.</div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <a class="mini-btn" href="#" id="open-premium-dashboard">Open Premium</a>
          <a class="mini-btn" href="#" id="manage-membership">Upgrade</a>
        </div>
      </div>
    </section>

    <footer>
      <p style="max-width:740px;margin:0 auto 6px;">
        <strong>Disclaimer:</strong>
        This content is for informational and educational purposes only, not financial advice.
        I am not a licensed financial advisor. Nothing here is a recommendation to buy or sell any financial asset.
      </p>
      <p>© 2026 FinTrend News · <a href="archive.html">Free Articles</a></p>
    </footer>
  </div>

  <!-- Auth modal (manual email+password; signup is default) -->
  <div id="auth-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
      <button class="modal-close" id="close-auth-modal" aria-label="Close">×</button>

      <div class="modal-kicker">FinTrend Account</div>
      <h2 class="modal-title" id="auth-modal-title">Create Free Account</h2>
      <p class="modal-subtitle" id="auth-subtitle">Create an account to unlock gated free articles and access Premium if you’ve upgraded.</p>

      <form id="auth-form" class="auth-form">
        <input id="auth-email" class="auth-input" type="email" placeholder="Email" required />
        <input id="auth-password" class="auth-input" type="password" placeholder="Password" required />

        <button type="submit" class="modal-primary-btn" id="auth-submit-btn" style="width:100%;">Create Free Account</button>

        <button type="button" class="modal-secondary-btn" id="auth-toggle-btn" style="width:100%;">Already have an account? Sign in</button>

        <div class="auth-msg" id="auth-msg"></div>

        <div style="margin-top:10px;border-top:1px solid rgba(148,163,184,0.25);padding-top:12px;">
          <button type="button" class="modal-secondary-btn" id="auth-reset-btn" style="width:100%;">Forgot password</button>
          <div class="auth-hint">Email is used for login only (no newsletters in this phase).</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Premium modal (kept for non-premium users; Stripe logic unchanged) -->
  <div id="premium-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="premium-modal-title">
      <button class="modal-close" id="close-premium-modal" aria-label="Close">×</button>

      <div class="modal-kicker">FinTrend Premium</div>
      <h2 class="modal-title" id="premium-modal-title">Upgrade to Premium</h2>
      <p class="modal-subtitle" id="premium-modal-subtitle">
        Premium unlocks premium.html (members dashboard) with deep dives and tools.
      </p>

      <div class="modal-btn-row">
        <a href="#" class="modal-primary-btn" id="go-premium-checkout">Go Premium</a>
        <a href="archive.html" class="modal-secondary-btn">Keep reading free</a>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // -----------------------------------------------------
      // Modals (generic)
      // -----------------------------------------------------
      function openModal(modal){
        if (!modal) return;
        modal.classList.add("active");
        modal.setAttribute("aria-hidden","false");
      }
      function closeModal(modal){
        if (!modal) return;
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden","true");
      }
      function closeAnyOpenModal(){
        document.querySelectorAll(".modal-backdrop.active").forEach(m=>closeModal(m));
      }

      window.addEventListener("keydown",(e)=>{
        if (e.key === "Escape") closeAnyOpenModal();
      });

      document.querySelectorAll(".modal-backdrop").forEach((backdrop)=>{
        backdrop.addEventListener("click",(e)=>{
          if (e.target === backdrop) closeModal(backdrop);
        });
      });

      // -----------------------------------------------------
      // Auth modal open/close
      // -----------------------------------------------------
      const authModal = document.getElementById("auth-modal");
      const openAuthBtn = document.getElementById("open-auth-modal");
      const heroCreateBtn = document.getElementById("hero-create-account");
      const closeAuthBtn = document.getElementById("close-auth-modal");

      function openAuthModal(e){
        if (e) e.preventDefault();
        openModal(authModal);
        const authMsg = document.getElementById("auth-msg");
        if (authMsg) authMsg.textContent = "";
        // Always default to signup when opening from CTAs
        if (window.__FTN__ && typeof window.__FTN__.setAuthMode === "function"){
          window.__FTN__.setAuthMode("signup");
        }
      }
      function closeAuthModal(){
        closeModal(authModal);
        const authMsg = document.getElementById("auth-msg");
        if (authMsg) authMsg.textContent = "";
      }

      if (openAuthBtn) openAuthBtn.addEventListener("click", openAuthModal);
      if (heroCreateBtn) heroCreateBtn.addEventListener("click", openAuthModal);
      if (closeAuthBtn) closeAuthBtn.addEventListener("click", closeAuthModal);

      // -----------------------------------------------------
      // Premium modal open/close
      // -----------------------------------------------------
      const premiumModal    = document.getElementById("premium-modal");
      const closePremiumBtn = document.getElementById("close-premium-modal");

      function openPremiumModal(e){
        if (e) e.preventDefault();
        openModal(premiumModal);
      }
      function closePremiumModal(){
        closeModal(premiumModal);
      }
      if (closePremiumBtn) closePremiumBtn.addEventListener("click", closePremiumModal);

      // Stripe payment link (LIVE) — unchanged
      const PAYMENT_LINK = "https://buy.stripe.com/aFabJ0auNdEVbnR4m2ffy00";
      const goPremiumCheckout = document.getElementById("go-premium-checkout");
      if (goPremiumCheckout){
        goPremiumCheckout.addEventListener("click",(e)=>{
          e.preventDefault();
          window.open(PAYMENT_LINK, "_blank", "noopener");
        });
      }

      // -----------------------------------------------------
      // Supabase Auth + Premium gating (kept logic, simpler UI)
      // -----------------------------------------------------
      (async function initSupabase(){
        try{
          if (!window.supabase || !window.supabase.createClient) {
            console.warn("[auth] Supabase library missing (cdn load failed).");
            return;
          }

          const SUPABASE_URL = "https://dxmdyperxyydqdshazcp.supabase.co".trim();
          const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4bWR5cGVyeHl5ZHFkc2hhemNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjMyNDQsImV4cCI6MjA4NDUzOTI0NH0.nMKF2wi8FWX0eYrDzSyJE_CPl8XgSMx27fPlcZ9gVzI".trim();

          const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
              persistSession: true,
              autoRefreshToken: true,
              detectSessionInUrl: true,
              storage: window.localStorage
            }
          });

          window.__FTN__ = window.__FTN__ || {};
          window.__FTN__.supabase = supabaseClient;

          // UI refs
          const authForm = document.getElementById("auth-form");
          const authEmail = document.getElementById("auth-email");
          const authPassword = document.getElementById("auth-password");
          const authMsg = document.getElementById("auth-msg");
          const authTitle = document.getElementById("auth-modal-title");
          const authSubtitle = document.getElementById("auth-subtitle");
          const authSubmitBtn = document.getElementById("auth-submit-btn");
          const authToggleBtn = document.getElementById("auth-toggle-btn");
          const authResetBtn = document.getElementById("auth-reset-btn");

          const signoutLink = document.getElementById("signout-link");
          const userChip = document.getElementById("user-chip");
          const userChipText = document.getElementById("user-chip-text");

          const premiumStatus = document.getElementById("premium-status");
          const navPremium = document.getElementById("nav-premium");
          const openPremiumDashboard = document.getElementById("open-premium-dashboard");
          const manageMembership = document.getElementById("manage-membership");

          let mode = "signup"; // default action
          let lastPremiumCheck = { ts: 0, isPremium: false, userId: null };

          function setMsg(text, isError=false){
            if (!authMsg) return;
            authMsg.textContent = text || "";
            authMsg.style.color = isError ? "#fca5a5" : "#e5e7eb";
          }

          function setPremiumStatus(text){
            if (premiumStatus) premiumStatus.textContent = text;
          }

          function humanAuthError(err){
            const msg = (err && err.message ? String(err.message) : "").toLowerCase();
            if (msg.includes("invalid login") || msg.includes("invalid") || msg.includes("credentials")) return "That email or password doesn’t look right. Try again.";
            if (msg.includes("email not confirmed")) return "Check your inbox and confirm your email, then sign in.";
            if (msg.includes("rate limit") || msg.includes("too many")) return "Too many attempts. Wait a minute and try again.";
            if (msg.includes("network") || msg.includes("fetch")) return "Network issue. Check your connection and try again.";
            if (msg.includes("jwt") || msg.includes("token")) return "Session issue. Refresh the page and try again.";
            return "We couldn’t complete that. Please try again.";
          }

          function setAuthMode(nextMode){
            mode = nextMode;

            if (!authTitle || !authSubtitle || !authSubmitBtn || !authToggleBtn) return;

            if (mode === "signup"){
              authTitle.textContent = "Create Free Account";
              authSubtitle.textContent = "Create an account to unlock gated free articles and access Premium if you’ve upgraded.";
              authSubmitBtn.textContent = "Create Free Account";
              authToggleBtn.textContent = "Already have an account? Sign in";
            } else {
              authTitle.textContent = "Sign in";
              authSubtitle.textContent = "Sign in to continue reading gated free articles and access Premium tools.";
              authSubmitBtn.textContent = "Sign in";
              authToggleBtn.textContent = "New here? Create free account";
            }

            setMsg("");
          }

          // expose so the CTA can force signup mode
          window.__FTN__.setAuthMode = setAuthMode;

          function setSignedOutUI(){
            if (signoutLink) signoutLink.style.display = "none";
            if (userChip) userChip.style.display = "none";
            if (userChipText) userChipText.textContent = "";
            if (userChip) userChip.classList.remove("premium");
            setPremiumStatus("Sign in to check access.");
          }

          function setSignedInUI(user, isPremium){
            if (signoutLink) signoutLink.style.display = "";
            if (userChip){
              userChip.style.display = "";
              userChip.classList.toggle("premium", !!isPremium);
            }
            const email = user?.email ? String(user.email) : "Signed in";
            if (userChipText){
              userChipText.textContent = isPremium ? ("Premium • " + email) : ("Signed in • " + email);
            }
          }

          async function getUserSafe(){
            const res = await supabaseClient.auth.getUser();
            if (res.error) return null;
            return res.data?.user || null;
          }

          async function getProfileSafe(user){
            if (!user) return { data: null, error: null };
            const { data, error } = await supabaseClient
              .from("profiles")
              .select("id,email,is_premium")
              .eq("id", user.id)
              .maybeSingle();
            return { data: data || null, error: error || null };
          }

          async function createProfileSafe(user){
            if (!user) return { data: null, error: null };
            const { data, error } = await supabaseClient
              .from("profiles")
              .insert([{ id: user.id, email: user.email, is_premium: false }])
              .select("id,email,is_premium")
              .single();
            return { data: data || null, error: error || null };
          }

          async function ensureProfileSafe(user){
            const existing = await getProfileSafe(user);
            if (existing.data) return existing;
            if (existing.error) return existing;
            return await createProfileSafe(user);
          }

          async function checkPremium(user){
            if (!user) return { user: null, isPremium: false, status: "signed_out" };

            const now = Date.now();
            if (lastPremiumCheck.userId === user.id && (now - lastPremiumCheck.ts) < 5000){
              return { user, isPremium: lastPremiumCheck.isPremium, status: "cached" };
            }

            const prof = await ensureProfileSafe(user);

            if (prof.error){
              lastPremiumCheck = { ts: now, isPremium: false, userId: user.id };
              return { user, isPremium: false, status: "profile_blocked" };
            }

            const isPremium = !!prof.data?.is_premium;
            lastPremiumCheck = { ts: now, isPremium, userId: user.id };
            return { user, isPremium, status: "ok" };
          }

          // Prevent overlapping refreshes
          let __refreshRunning = false;
          let __refreshQueued = false;

          function isAbortError(err){
            return err && (err.name === "AbortError" || String(err.message || "").toLowerCase().includes("signal is aborted"));
          }

          async function refreshUI(){
            if (__refreshRunning) { __refreshQueued = true; return; }
            __refreshRunning = true;

            try{
              const user = await getUserSafe();
              if (!user){
                setSignedOutUI();
                return;
              }

              const res = await checkPremium(user);
              setSignedInUI(user, res.isPremium);

              if (res.status === "profile_blocked"){
                setPremiumStatus("Signed in. Premium status can’t be verified right now.");
                return;
              }

              setPremiumStatus(res.isPremium ? "Premium member ✅" : "Not premium — upgrade to unlock Premium Deep Dives.");
            } catch(err){
              if (!isAbortError(err)) console.warn("[auth] refreshUI error:", err);
            } finally {
              __refreshRunning = false;
              if (__refreshQueued){
                __refreshQueued = false;
                setTimeout(refreshUI, 0);
              }
            }
          }

          // Premium routing (unchanged logic, just quieter UI)
          async function routePremium(e){
            if (e) e.preventDefault();

            const user = await getUserSafe();
            if (!user){
              // not logged in: open auth first (signup default)
              openAuthModal(e);
              setAuthMode("signup");
              setMsg("Create a free account (or sign in) to continue.", false);
              return;
            }

            const res = await checkPremium(user);

            if (res.status === "profile_blocked"){
              openPremiumModal(e);
              return;
            }

            if (res.isPremium){
              window.location.href = "premium.html";
              return;
            }

            openPremiumModal(e);
          }

          window.__FTN__.routePremium = routePremium;

          // Auth form handlers
          setAuthMode("signup");

          if (authToggleBtn){
            authToggleBtn.addEventListener("click",(e)=>{
              e.preventDefault();
              setAuthMode(mode === "signup" ? "signin" : "signup");
            });
          }

          if (authForm){
            authForm.addEventListener("submit", async (e)=>{
              e.preventDefault();
              setMsg("");

              const email = (authEmail?.value || "").trim();
              const password = (authPassword?.value || "");
              if (!email || !password){
                setMsg("Enter email + password.", true);
                return;
              }

              try{
                if (authSubmitBtn) authSubmitBtn.disabled = true;

                if (mode === "signin"){
                  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                  if (error) { setMsg(humanAuthError(error), true); return; }

                  setMsg("Signed in ✅", false);
                  closeAuthModal();
                  await refreshUI();
                  return;
                }

                // signup
                const { error } = await supabaseClient.auth.signUp({ email, password });
                if (error) { setMsg(humanAuthError(error), true); return; }

                setMsg("Account created. Check your email to confirm, then sign in.", false);
                // keep modal open so they see the message
              } catch(err){
                setMsg(humanAuthError(err), true);
              } finally {
                if (authSubmitBtn) authSubmitBtn.disabled = false;
              }
            });
          }

          if (authResetBtn){
            authResetBtn.addEventListener("click", async (e)=>{
              e.preventDefault();
              setMsg("");

              const email = (authEmail?.value || "").trim();
              if (!email){
                setMsg("Type your email above first, then click Forgot password.", true);
                return;
              }

              try{
                const origin = window.location.origin;
                const redirectTo = (origin && origin !== "null") ? (origin + "/") : undefined;

                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, redirectTo ? { redirectTo } : undefined);
                if (error) { setMsg(humanAuthError(error), true); return; }

                setMsg("Password reset email sent. Check your inbox.", false);
              } catch(err){
                setMsg(humanAuthError(err), true);
              }
            });
          }

          if (signoutLink){
            signoutLink.addEventListener("click", async (e)=>{
              e.preventDefault();
              try{ await supabaseClient.auth.signOut(); } catch(_){}
              setSignedOutUI();
              closeAnyOpenModal();
            });
          }

          // Wire premium links/buttons
          [navPremium, openPremiumDashboard].filter(Boolean).forEach(el => el.addEventListener("click", routePremium));

          if (manageMembership){
            manageMembership.addEventListener("click",(e)=>{
              e.preventDefault();
              window.open(PAYMENT_LINK, "_blank", "noopener");
            });
          }

          // Keep UI in sync
          supabaseClient.auth.onAuthStateChange(async ()=>{
            await refreshUI();
          });

          // Initial sync
          await refreshUI();

        } catch(err){
          console.warn("[auth] initSupabase error:", err);
        }
      })();

    })();
  </script>
</body>
</html>
